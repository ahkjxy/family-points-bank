# 家庭元气银行 · 功能与使用文档

## 概览
- 本应用是基于 React + Vite 的家庭积分管理工具，所有界面为单页路由。
- 路由：
  - `/dashboard` 账户概览
  - `/earn` 任务中心（赚取/扣减）
  - `/redeem` 梦想商店（兑换奖品）
  - `/history` 能量账单
  - `/settings` 系统配置（仅管理员可见）

## 页面与操作
### 账户概览 `/dashboard`
- 查看当前登录成员的余额、今日收益、最近 4 条账单。
- 快捷按钮跳转到任务中心或梦想商店。

### 任务中心 `/earn`
- 列表分组：学习/家务/自律/违规。
- 任意行点击即录入元气值（违规为扣减）。
- 行内展示：频率徽标 + 标题 + 描述 + 周期 + 分值胶囊，交替底色，hover 高亮。

### 梦想商店 `/redeem`
- 展示奖品卡片（图片或占位图标），显示所需积分。
- 余额不足自动置灰禁用；可负担时点击弹出确认并扣减。

### 能量账单 `/history`
- 当前成员的全部交易表格（日期、说明、数值正负色）。

### 系统配置 `/settings`（管理员）
- 同步云端：手动触发远端 kvdb 同步（会同时更新本地缓存）。
- 打印制度手册：生成并打印 HTML 规则手册。
- 任务配置：筛选 chips + 列表，支持新增/编辑/删除，分值显示，hover 快捷操作。
- 奖品配置：同样的筛选/列表样式，支持上传图片、编辑、下架。

### 弹窗与交互
- 账户切换：从侧栏入口，切换后立即生效。
- 操作确认：任务/兑换点击后弹窗确认再入账。
- 规则编辑：表单含标题、分值、周期下拉（每日/每次/每周/每月/每学期/每年）、分类/类型、描述，奖品可上传图片。

## 数据与同步
- 远端存储：kvdb（`SYNC_API_PREFIX` + `FIXED_SYNC_ID`）。
- 本地持久化：`localStorage` key `family-bank-state-v1`。
- 启动加载：优先读取本地，有本地则不请求远端；无本地时再拉取 kvdb。
- 写入路径（赚取/扣减/兑换、任务/奖品 CRUD）：
  1) 先写入本地缓存
  2) 再尝试 POST 到 kvdb（失败也不阻塞本地更新）
- 手动同步：设置页“同步云端”会强制请求 kvdb 并刷新本地。

## 权限
- 管理员：可见/访问设置页，允许新增/编辑/删除任务与奖品，打印、同步。
- 普通成员：仅可查看和执行任务、兑换、查看账单。

## 开发与运行
- Node 环境，安装依赖：`yarn install`
- 启动：`yarn dev`
- 构建：`yarn build`
- 浏览器访问：`http://localhost:5173`

## 安卓打包/调试（Capacitor）
- 同步 Web 资源与原生依赖：`yarn android:sync`
- 打开 Android Studio 工程：`yarn android:open`
- 前置：已安装 Android Studio/SDK，首次需在 Android Studio 同步 Gradle 并配置签名（发布版）。

## 常见操作流程
- 录入任务：进入“任务中心”点击行 -> 确认弹窗 -> 确认后入账并同步。
- 兑换奖品：进入“梦想商店”点击可负担的奖品 -> 确认弹窗 -> 扣减余额并同步。
- 新增任务/奖品：设置页点击“新增规则/上架新品” -> 填写表单 -> 保存即写本地并尝试云同步。
- 手动同步：设置页点击“同步云端”强制拉取远端并覆盖本地缓存。

## 重要提示
- 若 kvdb 不可用，操作仍会写入本地缓存并保留；待网络恢复后可手动同步。
- 本地缓存包含全部状态（成员、任务、奖品、历史），如需重置可清空浏览器 localStorage。
