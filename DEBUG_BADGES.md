# ğŸ› å¾½ç« åŠŸèƒ½é”™è¯¯ä¿®å¤

## é—®é¢˜æè¿°

æˆå°±ä¸­å¿ƒé¡µé¢æŠ¥é”™ï¼š
1. **22P02 é”™è¯¯**: `invalid input syntax for type uuid: "p-sister1"` 
2. **42702 é”™è¯¯**: `column reference "type" is ambiguous`

## æ ¹æœ¬åŸå› 

1. **UUID éªŒè¯é—®é¢˜**: å‰ç«¯ Profile çš„ `id` å¯èƒ½æ˜¯æœ¬åœ°å­—ç¬¦ä¸²ï¼ˆå¦‚ "p-sister1", "guest"ï¼‰ï¼Œè€Œæ•°æ®åº“å‡½æ•°éœ€è¦ UUID
2. **SQL åˆ—åå†²çª**: `get_available_badges` å‡½æ•°ä¸­è¿”å›çš„åˆ—åä¸è¡¨åˆ—åå†²çª

## ä¿®å¤å†…å®¹

### 1. SQL å‡½æ•°ä¿®å¤ (`run_all_migrations.sql`)

- âœ… å°†æ‰€æœ‰å‡½æ•°ä½“åˆ†éš”ç¬¦ä» `$` æ”¹ä¸º `$$`ï¼ˆSupabase æ ‡å‡†è¯­æ³•ï¼‰
- âœ… åœ¨ `get_available_badges` å‡½æ•°ä¸­æ˜ç¡®æŒ‡å®šåˆ—åˆ«åï¼ˆ`AS condition`, `AS type` ç­‰ï¼‰

### 2. BadgeSection ç»„ä»¶ä¿®å¤

- âœ… æ·»åŠ  `isValidUUID()` éªŒè¯å‡½æ•°
- âœ… åœ¨ `loadBadges()` ä¸­æ£€æŸ¥ UUID æœ‰æ•ˆæ€§ï¼Œæ— æ•ˆæ—¶è·³è¿‡ API è°ƒç”¨
- âœ… åœ¨ `handleClaimBadges()` ä¸­æ£€æŸ¥ UUIDï¼Œæ— æ•ˆæ—¶æ˜¾ç¤ºå‹å¥½æç¤º
- âœ… åœ¨ UI ä¸­æ˜¾ç¤º"æ•°æ®æœªåŒæ­¥"æç¤ºï¼Œå¼•å¯¼ç”¨æˆ·åŒæ­¥æ•°æ®

### 3. PointsPrediction ç»„ä»¶ä¿®å¤

- âœ… æ·»åŠ  `isValidUUID()` éªŒè¯å‡½æ•°
- âœ… åœ¨ `useEffect` ä¸­æ£€æŸ¥ UUID æœ‰æ•ˆæ€§
- âœ… åœ¨ UI ä¸­æ˜¾ç¤º"æ•°æ®æœªåŒæ­¥"æç¤º

## ä½¿ç”¨è¯´æ˜

### æ‰§è¡Œæ•°æ®åº“è¿ç§»

1. æ‰“å¼€ Supabase Dashboard â†’ SQL Editor
2. å¤åˆ¶ `supabase/migrations/run_all_migrations.sql` å…¨éƒ¨å†…å®¹
3. ç²˜è´´å¹¶ç‚¹å‡» Run
4. ç­‰å¾…æ‰§è¡Œå®Œæˆï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   ```
   âœ… è¿ç§»å®Œæˆï¼
   ğŸ“Š æ–°å¢è¡¨æ•°é‡: 5 / 5
   ğŸ”§ æ–°å¢å‡½æ•°æ•°é‡: 5 / 5
   ğŸ… å¾½ç« å®šä¹‰æ•°é‡: 13
   ğŸ‰ æ‰€æœ‰åŠŸèƒ½å·²æˆåŠŸéƒ¨ç½²ï¼
   ```

### ç”¨æˆ·ä½“éªŒ

- **å·²åŒæ­¥ç”¨æˆ·**: å¯ä»¥æ­£å¸¸ä½¿ç”¨æˆå°±ä¸­å¿ƒï¼ŒæŸ¥çœ‹å’Œé¢†å–å¾½ç« 
- **æœªåŒæ­¥ç”¨æˆ·**: çœ‹åˆ°å‹å¥½æç¤º"æ•°æ®æœªåŒæ­¥ï¼Œè¯·å‰å¾€è®¾ç½®é¡µé¢å®Œæˆæ•°æ®åŒæ­¥"
- **Guest ç”¨æˆ·**: åŒæ ·çœ‹åˆ°æç¤ºï¼Œä¸ä¼šæŠ¥é”™

## æŠ€æœ¯ç»†èŠ‚

### UUID éªŒè¯æ­£åˆ™

```typescript
const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
```

### SQL å‡½æ•°åˆ—è¡¨

1. `get_difficulty_multiplier(difficulty TEXT)` - è·å–éš¾åº¦ç³»æ•°
2. `get_available_badges(p_profile_id UUID)` - è·å–å¯è·å¾—çš„å¾½ç« 
3. `grant_eligible_badges(p_profile_id UUID)` - æ‰¹é‡æˆäºˆå¾½ç« 
4. `get_family_leaderboard(p_family_id UUID, p_period TEXT)` - è·å–æ’è¡Œæ¦œ
5. `check_and_grant_badges()` - è‡ªåŠ¨æ£€æŸ¥å¹¶æˆäºˆå¾½ç« ï¼ˆè§¦å‘å™¨ï¼‰

## æµ‹è¯•å»ºè®®

1. âœ… æµ‹è¯•æœªåŒæ­¥ç”¨æˆ·è®¿é—®æˆå°±ä¸­å¿ƒ
2. âœ… æµ‹è¯•å·²åŒæ­¥ç”¨æˆ·æŸ¥çœ‹å¾½ç« 
3. âœ… æµ‹è¯•é¢†å–å¾½ç« åŠŸèƒ½
4. âœ… æµ‹è¯•ç§¯åˆ†é¢„æµ‹åŠŸèƒ½
5. âœ… æµ‹è¯• Guest ç”¨æˆ·è®¿é—®

---

**çŠ¶æ€**: âœ… å·²ä¿®å¤
**æ—¥æœŸ**: 2026-01-16
